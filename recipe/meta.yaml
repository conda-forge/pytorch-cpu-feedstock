# if you wish to build release candidate number X, append the version string with ".rcX"
{% set version = "2.7.1" %}
{% set build = 5 %}

# Use a higher build number for the CUDA variant, to ensure that it's
# preferred by conda's solver, and it's preferentially
# installed where the platform supports it.
{% if cuda_compiler_version != "None" %}
{% set build = build + 200 %}
{% endif %}

{% if blas_impl == "mkl" %}
{% set build = build + 100 %}
{% endif %}

# see https://github.com/pytorch/pytorch/blame/v{{ version }}/.ci/docker/ci_commit_pins/triton.txt
# pytorch and triton are released in tandem, see notes in their release process
# https://github.com/pytorch/pytorch/blob/main/RELEASE.md#triton-dependency-for-the-release
{% set triton = "3.3.1" %}

# TODO Temporary pin, remove me
{% set mkl = "<2025" %}

package:
  name: libtorch
  version: {{ version.replace("-", ".") }}

source:
{% if "rc" in version %}
  # - git_url: https://github.com/pytorch/pytorch.git
  #   git_rev: v{{ version.replace(".rc", "-rc") }}
  # we cannot apply patches to submodules when checking out with git_url, because
  # then conda switches the patch-application to use git, which cannot construct
  # a usable ancestor from outside the submodule; the only option then is to
  # pull in the submodules separately.
  - url: https://github.com/pytorch/pytorch/archive/refs/tags/v{{ version }}.tar.gz
    sha256: 04ae0a8babdc9cb9dfc4f8746b2b8aa0f8ed0f9e92835cc4af0bcb01e3969e51
{% else %}
  # The "pytorch-v" tarballs contain submodules; the "pytorch-" ones don't.
  - url: https://github.com/pytorch/pytorch/releases/download/v{{ version }}/pytorch-v{{ version }}.tar.gz
    sha256: 5befd2e540fd55ce4782d0ca7610ce5b572d756d7ea38090ef0f3c7c428fb20f
{% endif %}
    patches:
      - patches/0001-Force-usage-of-python-3-and-error-without-numpy.patch
      # backport https://github.com/pytorch/pytorch/pull/137084
      - patches/0002-Help-find-numpy.patch
      - patches/0003-Fix-duplicate-linker-script.patch  # [cuda_compiler_version != "None" and aarch64]
      # conda-specific patch, lets us override CUDA paths
      - patches/0004-Allow-overriding-CUDA-related-paths.patch
      # fix BLAS calling convention for openblas
      - patches/0005-Use-BLAS_USE_CBLAS_DOT-for-OpenBLAS-builds.patch
      # fix mkl-2024 issue
      # https://github.com/pytorch/pytorch/pull/143894
      - patches/0006-fix-issue-142484.patch
      - patches/0007-Fix-FindOpenBLAS.patch
      # point to headers that are now living in $PREFIX/include instead of $SP_DIR/torch/include
      - patches/0008-point-include-paths-to-PREFIX-include.patch
      - patches/0009-Add-conda-prefix-to-inductor-include-paths.patch
      - patches/0010-make-ATEN_INCLUDE_DIR-relative-to-TORCH_INSTALL_PREF.patch
      - patches/0011-remove-DESTINATION-lib-from-CMake-install-TARGETS-di.patch                       # [win]
      - patches/0012-avoid-deprecated-find_package-CUDA-in-caffe2-CMake-m.patch
      # backport https://github.com/pytorch/pytorch/pull/148668
      - patches/0013-Fix-CUPTI-lookup-to-include-target-directory.patch
      # backport (practically speaking) https://github.com/pytorch/pytorch/pull/149861
      - patches/0014-Always-use-system-nvtx.patch
      # https://github.com/pytorch/pytorch/pull/152533
      - patches/0015-Do-not-check-out-nccl-when-not-building-it.patch
      # skip a test that fails with numpy 2.3; can be dropped for pytorch>2.7
      - patches/0016-skip-test_norm_matrix_degenerate_shapes-on-numpy-2.3.patch
      # backport https://github.com/pytorch/pytorch/pull/127702
      - patches/0017-Define-PY_SSIZE_T_CLEAN-before-include-Python.h.patch
      - patches_submodules/fbgemm/0001-remove-DESTINATION-lib-from-CMake-install-directives.patch     # [win]
      - patches_submodules/tensorpipe/0001-switch-away-from-find_package-CUDA.patch

build:
  number: {{ build }}
  # This logic allows two rc variants to be defined in the conda_build_config, but only one to actually be built.
  # We want to be able to define two variants in the cbc so we can assign different labels to each in the upload channel
  # (by zipping is_rc with channel_targets). This prevents rc builds being used unless specifically requested.
{% if "rc" in version %}
  skip: true  # [not is_rc]
{% else %}
  skip: true  # [is_rc]
{% endif %}
  skip: true  # [not linux64 or cuda_compiler_version == "None" or blas_impl != "mkl"]
  string: cuda{{ cuda_compiler_version | replace('.', '') }}_{{ blas_impl }}_h{{ PKG_HASH }}_{{ build }}  # [cuda_compiler_version != "None"]
  string: cpu_{{ blas_impl }}_h{{ PKG_HASH }}_{{ build }}                                                 # [cuda_compiler_version == "None"]
  detect_binary_files_with_prefix: false
  run_exports:
    - {{ pin_subpackage('libtorch', max_pin='x.x') }}
  ignore_run_exports_from:
    - python *                               # [megabuild]
    - numpy *                                # [megabuild]
    - cross-python_{{ target_platform }}     # [megabuild and build_platform != target_platform]
  ignore_run_exports:
    - python *                               # [megabuild]
    - numpy *                                # [megabuild]
    - libmagma_sparse

requirements:
  build:
    - _libgcc_mutex 0.1 conda_forge
    - _openmp_mutex 4.5 2_gnu
    - binutils_impl_linux-64 2.44 h4bf12b8_1
    - binutils_linux-64 2.44 h4852527_1
    - bzip2 1.0.8 h4bc722e_7
    - c-ares 1.34.5 hb9d3cd8_0
    - ca-certificates 2025.7.14 hbd8a1cb_0
    - cmake 3.31.6 h74e3db0_0
    - cuda-cccl_linux-64 12.9.27 ha770c72_0
    - cuda-crt-dev_linux-64 12.9.86 ha770c72_1
    - cuda-crt-tools 12.9.86 ha770c72_1
    - cuda-cudart 12.9.79 h5888daf_0
    - cuda-cudart-dev 12.9.79 h5888daf_0
    - cuda-cudart-dev_linux-64 12.9.79 h3f2d84a_0
    - cuda-cudart-static 12.9.79 h5888daf_0
    - cuda-cudart-static_linux-64 12.9.79 h3f2d84a_0
    - cuda-cudart_linux-64 12.9.79 h3f2d84a_0
    - cuda-driver-dev_linux-64 12.9.79 h3f2d84a_0
    - cuda-nvcc-dev_linux-64 12.9.86 he91c749_1
    - cuda-nvcc-impl 12.9.86 h85509e4_1
    - cuda-nvcc-tools 12.9.86 he02047a_1
    - cuda-nvcc_linux-64 12.9.86 he0b4e1d_1
    - cuda-nvvm-dev_linux-64 12.9.86 ha770c72_1
    - cuda-nvvm-impl 12.9.86 he02047a_1
    - cuda-nvvm-tools 12.9.86 he02047a_1
    - cuda-version 12.9 h4f385c5_3
    - gcc_impl_linux-64 14.3.0 hd9e9e21_3
    - gcc_linux-64 14.3.0 h1382650_11
    - grep 3.11 h7af0fdc_3
    - gxx_impl_linux-64 14.3.0 he663afc_3
    - gxx_linux-64 14.3.0 ha7acb78_11
    - icu 75.1 he02047a_0
    - kernel-headers_linux-64 3.10.0 he073ed8_18
    - keyutils 1.6.1 h166bdaf_0
    - krb5 1.21.3 h659f571_0
    - ld_impl_linux-64 2.44 h1423503_1
    - libabseil 20250512.1 cxx17_hba17884_0
    - libcurl 8.14.1 h332b0f4_0
    - libedit 3.1.20250104 pl5321h7949ede_0
    - libev 4.33 hd590300_2
    - libexpat 2.7.1 hecca717_0
    - libffi 3.4.6 h2dba641_1
    - libgcc 15.1.0 h767d61c_3
    - libgcc-devel_linux-64 14.3.0 h85bb3a7_103
    - libgcc-ng 15.1.0 h69a702a_3
    - libgomp 15.1.0 h767d61c_3
    - libiconv 1.18 h4ce23a2_1
    - liblzma 5.8.1 hb9d3cd8_2
    - libmpdec 4.0.0 hb9d3cd8_0
    - libnghttp2 1.64.0 h161d5f1_0
    - libprotobuf 6.31.1 h9ef548d_1
    - libsanitizer 14.3.0 hd08acf3_3
    - libsqlite 3.50.3 hee844dc_1
    - libssh2 1.11.1 hcf80075_0
    - libstdcxx 15.1.0 h8f9b012_3
    - libstdcxx-devel_linux-64 14.3.0 h85bb3a7_103
    - libstdcxx-ng 15.1.0 h4852527_3
    - libuuid 2.38.1 h0b41bf4_0
    - libuv 1.51.0 hb9d3cd8_0
    - libzlib 1.3.1 hb9d3cd8_2
    - llvm-openmp 20.1.8 h4922eb0_0
    - lz4-c 1.10.0 h5888daf_1
    - make 4.4.1 hb9d3cd8_2
    - ncurses 6.5 h2d0b736_3
    - ninja 1.13.1 h171cf75_0
    - openssl 3.5.1 h7b32b05_0
    - pcre2 10.44 hc749103_2
    - popt 1.16 h0b475e3_2002
    - protobuf 6.31.1 py313hc6d18d0_0
    - python 3.13.5 hec9711d_102_cp313
    - python_abi 3.13 8_cp313
    - readline 8.2 h8c095d6_2
    - rhash 1.4.6 hb9d3cd8_1
    - rsync 3.4.1 h81c0278_2
    - sysroot_linux-64 2.17 h0157908_18
    - tk 8.6.13 noxft_hd72426e_102
    - tzdata 2025b h78e105d_0
    - xxhash 0.8.3 hb47aa4a_0
    - zstd 1.5.7 hb8e6e7a_2
  host:
    - _openmp_mutex 4.5 3_kmp_llvm
    - attr 2.5.1 h166bdaf_1
    - brotli-python 1.1.0 py312h2ec8cdc_3
    - bzip2 1.0.8 h4bc722e_7
    - ca-certificates 2025.7.14 hbd8a1cb_0
    - certifi 2025.7.14 pyhd8ed1ab_0
    - cffi 1.17.1 py312h06ac9bb_0
    - charset-normalizer 3.4.2 pyhd8ed1ab_0
    - cuda-cccl_linux-64 12.9.27 ha770c72_0
    - cuda-crt-dev_linux-64 12.9.86 ha770c72_1
    - cuda-cudart 12.9.79 h5888daf_0
    - cuda-cudart-dev 12.9.79 h5888daf_0
    - cuda-cudart-dev_linux-64 12.9.79 h3f2d84a_0
    - cuda-cudart-static 12.9.79 h5888daf_0
    - cuda-cudart-static_linux-64 12.9.79 h3f2d84a_0
    - cuda-cudart_linux-64 12.9.79 h3f2d84a_0
    - cuda-cupti 12.9.79 h9ab20c4_0
    - cuda-cupti-dev 12.9.79 h9ab20c4_0
    - cuda-driver-dev 12.9.79 h5888daf_0
    - cuda-driver-dev_linux-64 12.9.79 h3f2d84a_0
    - cuda-nvml-dev 12.9.79 hbd13f7d_0
    - cuda-nvrtc 12.9.86 h5888daf_0
    - cuda-nvrtc-dev 12.9.86 h5888daf_0
    - cuda-nvtx 12.9.79 h5888daf_0
    - cuda-nvtx-dev 12.9.79 ha770c72_0
    - cuda-profiler-api 12.9.79 h7938cbb_0
    - cuda-version 12.9 h4f385c5_3
    - cudnn 9.10.1.4 hbcb9cd8_1
    - cusparselt 0.7.1.0 h58dd1b1_2
    - eigen 3.4.0 h00ab1b0_0
    - h2 4.2.0 pyhd8ed1ab_0
    - hpack 4.1.0 pyhd8ed1ab_0
    - hyperframe 6.1.0 pyhd8ed1ab_0
    - icu 75.1 he02047a_0
    - idna 3.10 pyhd8ed1ab_1
    - ld_impl_linux-64 2.44 h1423503_1
    - libabseil 20250512.1 cxx17_hba17884_0
    - libblas 3.9.0 32_hfdb39a5_mkl
    - libcap 2.75 h39aace5_0
    - libcblas 3.9.0 32_h372d94f_mkl
    - libcublas 12.9.1.4 h9ab20c4_0
    - libcublas-dev 12.9.1.4 h9ab20c4_0
    - libcudnn 9.10.1.4 hf7e9902_1
    - libcudnn-dev 9.10.1.4 h58dd1b1_1
    - libcudss 0.6.0.5 h58dd1b1_0
    - libcudss-dev 0.6.0.5 hee47b17_0
    - libcufft 11.4.1.4 h5888daf_0
    - libcufft-dev 11.4.1.4 h5888daf_0
    - libcufile 1.14.1.1 ha8da6e3_0
    - libcufile-dev 1.14.1.1 h5888daf_0
    - libcurand 10.3.10.19 h9ab20c4_0
    - libcurand-dev 10.3.10.19 h9ab20c4_0
    - libcusolver 11.7.5.82 h9ab20c4_1
    - libcusolver-dev 11.7.5.82 h9ab20c4_1
    - libcusparse 12.5.10.65 h5888daf_1
    - libcusparse-dev 12.5.10.65 h5888daf_1
    - libexpat 2.7.1 hecca717_0
    - libffi 3.4.6 h2dba641_1
    - libgcc 15.1.0 h767d61c_3
    - libgcc-ng 15.1.0 h69a702a_3
    - libgcrypt-lib 1.11.1 hb9d3cd8_0
    - libgpg-error 1.55 h3f2d84a_0
    - libhwloc 2.11.2 default_h3d81e11_1002
    - libiconv 1.18 h4ce23a2_1
    - liblapack 3.9.0 32_hc41d3b0_mkl
    - liblzma 5.8.1 hb9d3cd8_2
    - libmagma 2.9.0 h9918c94_2
    - libmagma_sparse 2.9.0 h4951f4c_1
    - libnl 3.11.0 hb9d3cd8_0
    - libnsl 2.0.1 hb9d3cd8_1
    - libnvjitlink 12.9.86 h5888daf_1
    - libprotobuf 6.31.1 h9ef548d_1
    - libsqlite 3.50.3 hee844dc_1
    - libstdcxx 15.1.0 h8f9b012_3
    - libstdcxx-ng 15.1.0 h4852527_3
    - libsystemd0 257.7 h4e0b6ca_0
    - libudev1 257.7 hbe16f8c_0
    - libuuid 2.38.1 h0b41bf4_0
    - libuv 1.51.0 hb9d3cd8_0
    - libxcrypt 4.4.36 hd590300_1
    - libxml2 2.13.8 h4bc477f_0
    - libzlib 1.3.1 hb9d3cd8_2
    - llvm-openmp 20.1.8 h4922eb0_0
    - lz4-c 1.10.0 h5888daf_1
    - magma 2.9.0 h622db9b_1
    - mkl 2024.2.2 ha957f24_16
    - mkl-devel 2024.2.2 ha770c72_16
    - mkl-include 2024.2.2 ha957f24_16
    - nccl 2.27.7.1 h49b9d9a_0
    - ncurses 6.5 h2d0b736_3
    - numpy 2.3.2 py312h33ff503_0
    - nvtx-c 3.2.1 h3e4d06c_0
    - openssl 3.5.1 h7b32b05_0
    - pip 25.1.1 pyh8b19718_0
    - pkg-config 0.29.2 h4bc722e_1009
    - pybind11 3.0.0 pyh9380348_1
    - pybind11-global 3.0.0 pyhf748d72_1
    - pycparser 2.22 pyh29332c3_1
    - pysocks 1.7.1 pyha55dd90_7
    - python 3.12.11 h9e4cc4f_0_cpython
    - python_abi 3.12 8_cp312
    - pyyaml 6.0.2 py312h178313f_2
    - rdma-core 58.0 h5888daf_0
    - readline 8.2 h8c095d6_2
    - requests 2.32.4 pyhd8ed1ab_0
    - setuptools 80.9.0 pyhff2d567_0
    - six 1.17.0 pyhe01879c_1
    - sleef 3.8 h1b44611_0
    - tbb 2021.13.0 hceb3a55_1
    - tk 8.6.13 noxft_hd72426e_102
    - typing_extensions 4.14.1 pyhe01879c_0
    - tzdata 2025b h78e105d_0
    - urllib3 2.5.0 pyhd8ed1ab_0
    - wheel 0.45.1 pyhd8ed1ab_1
    - yaml 0.2.5 h280c20c_3
    - zlib 1.3.1 hb9d3cd8_2
    - zstandard 0.23.0 py312h66e93f0_2
    - zstd 1.5.7 hb8e6e7a_2
  run_constrained:
    # These constraints ensure conflict between pytorch and
    # pytorch-cpu 1.1 which we built before conda-forge had GPU infrastructure
    # built into place.
    # https://github.com/conda-forge/pytorch-cpu-feedstock/issues/65
    - pytorch-cpu {{ version }}    # [cuda_compiler_version == "None"]
    - pytorch-gpu <0.0a0           # [cuda_compiler_version == "None"]
    - pytorch-gpu {{ version }}    # [cuda_compiler_version != "None"]
    - pytorch-cpu <0.0a0           # [cuda_compiler_version != "None"]
    - pytorch {{ version }} cuda{{ cuda_compiler_version | replace('.', '') }}_{{ blas_impl }}_*_{{ build }}  # [cuda_compiler_version != "None"]
    - pytorch {{ version }} cpu_{{ blas_impl }}_*_{{ build }}                                                 # [cuda_compiler_version == "None"]
    # if using OpenBLAS, ensure that a version compatible with OpenMP is used
    # otherwise, we get the following warnings:
    # OpenBLAS Warning : Detect OpenMP Loop and this application may hang. Please rebuild the library with USE_OPENMP=1 option.
    - libopenblas * openmp_*          # [unix and blas_impl != "mkl"]
    - openblas * openmp_*          # [unix and blas_impl != "mkl"]

# these tests are for the libtorch output below, but due to
# a particularity of conda-build, that output is defined in
# the global build stage, including tests
test:
  requires:
    # cmake needs a compiler to run package detection, see
    # https://discourse.cmake.org/t/questions-about-find-package-cli-msvc/6194
    - {{ compiler('cxx') }}
    # for CMake config to find cuda & nvrtc
    - {{ compiler('cuda') }}    # [cuda_compiler_version != "None"]
    - cuda-nvrtc-dev            # [cuda_compiler_version != "None"]
    - nvtx-c =3.2.1                    # [cuda_compiler_version != "None"]
    - rdma-core =58.0
    - cmake <4
    - ninja
    - pkg-config
  files:
    - cmake_test/
  commands:
    # libraries; peculiar formatting to avoid linter false positives about selectors
    {% set torch_libs = [
        "c10", "shm", "torch", "torch_cpu", "torch_global_deps"
    ] + (cuda_compiler_version != "None" and target_platform.startswith("linux")) * [
        "torch_cuda_linalg"
    ] + (cuda_compiler_version != "None") * [
        "c10_cuda", "caffe2_nvrtc", "torch_cuda"
    ] + target_platform.startswith("win") * [
        "asmjit", "fbgemm"
    ]
    %}
    {% for each_lib in torch_libs %}
    - test -f $PREFIX/lib/lib{{ each_lib }}.so              # [linux]
    - test -f $PREFIX/lib/lib{{ each_lib }}.dylib           # [osx]
    - if not exist %LIBRARY_BIN%\{{ each_lib }}.dll exit 1  # [win]
    {% if each_lib != "torch_global_deps" %}
    - if not exist %LIBRARY_LIB%\{{ each_lib }}.lib exit 1  # [win]
    {% endif %}
    {% endfor %}

    # CMake files in share
    - test -f $PREFIX/share/cmake/Torch/TorchConfig.cmake                       # [linux]
    - if not exist %LIBRARY_PREFIX%\share\cmake\Torch\TorchConfig.cmake exit 1  # [win]

outputs:
  - name: libtorch
  - name: pytorch
    script: build.sh    # [unix]
    script: bld.bat     # [win]
    build:
      string: cuda{{ cuda_compiler_version | replace('.', '') }}_{{ blas_impl }}_py{{ CONDA_PY }}_h{{ PKG_HASH }}_{{ build }}  # [cuda_compiler_version != "None"]
      string: cpu_{{ blas_impl }}_py{{ CONDA_PY }}_h{{ PKG_HASH }}_{{ build }}                                                 # [cuda_compiler_version == "None"]
      detect_binary_files_with_prefix: false
      run_exports:
        - {{ pin_subpackage('pytorch', max_pin='x.x') }}
        - {{ pin_subpackage('libtorch', max_pin='x.x') }}
      ignore_run_exports:
        - libmagma_sparse
    requirements:
      build:
        - _libgcc_mutex 0.1 conda_forge
        - _openmp_mutex 4.5 2_gnu
        - binutils_impl_linux-64 2.44 h4bf12b8_1
        - binutils_linux-64 2.44 h4852527_1
        - bzip2 1.0.8 h4bc722e_7
        - c-ares 1.34.5 hb9d3cd8_0
        - ca-certificates 2025.7.14 hbd8a1cb_0
        - cmake 3.31.6 h74e3db0_0
        - cuda-cccl_linux-64 12.9.27 ha770c72_0
        - cuda-crt-dev_linux-64 12.9.86 ha770c72_1
        - cuda-crt-tools 12.9.86 ha770c72_1
        - cuda-cudart 12.9.79 h5888daf_0
        - cuda-cudart-dev 12.9.79 h5888daf_0
        - cuda-cudart-dev_linux-64 12.9.79 h3f2d84a_0
        - cuda-cudart-static 12.9.79 h5888daf_0
        - cuda-cudart-static_linux-64 12.9.79 h3f2d84a_0
        - cuda-cudart_linux-64 12.9.79 h3f2d84a_0
        - cuda-driver-dev_linux-64 12.9.79 h3f2d84a_0
        - cuda-nvcc-dev_linux-64 12.9.86 he91c749_1
        - cuda-nvcc-impl 12.9.86 h85509e4_1
        - cuda-nvcc-tools 12.9.86 he02047a_1
        - cuda-nvcc_linux-64 12.9.86 he0b4e1d_1
        - cuda-nvvm-dev_linux-64 12.9.86 ha770c72_1
        - cuda-nvvm-impl 12.9.86 he02047a_1
        - cuda-nvvm-tools 12.9.86 he02047a_1
        - cuda-version 12.9 h4f385c5_3
        - gcc_impl_linux-64 14.3.0 hd9e9e21_3
        - gcc_linux-64 14.3.0 h1382650_11
        - gxx_impl_linux-64 14.3.0 he663afc_3
        - gxx_linux-64 14.3.0 ha7acb78_11
        - icu 75.1 he02047a_0
        - kernel-headers_linux-64 3.10.0 he073ed8_18
        - keyutils 1.6.1 h166bdaf_0
        - krb5 1.21.3 h659f571_0
        - ld_impl_linux-64 2.44 h1423503_1
        - libabseil 20250512.1 cxx17_hba17884_0
        - libcurl 8.14.1 h332b0f4_0
        - libedit 3.1.20250104 pl5321h7949ede_0
        - libev 4.33 hd590300_2
        - libexpat 2.7.1 hecca717_0
        - libffi 3.4.6 h2dba641_1
        - libgcc 15.1.0 h767d61c_3
        - libgcc-devel_linux-64 14.3.0 h85bb3a7_103
        - libgcc-ng 15.1.0 h69a702a_3
        - libgomp 15.1.0 h767d61c_3
        - liblzma 5.8.1 hb9d3cd8_2
        - libmpdec 4.0.0 hb9d3cd8_0
        - libnghttp2 1.64.0 h161d5f1_0
        - libprotobuf 6.31.1 h9ef548d_1
        - libsanitizer 14.3.0 hd08acf3_3
        - libsqlite 3.50.3 hee844dc_1
        - libssh2 1.11.1 hcf80075_0
        - libstdcxx 15.1.0 h8f9b012_3
        - libstdcxx-devel_linux-64 14.3.0 h85bb3a7_103
        - libstdcxx-ng 15.1.0 h4852527_3
        - libuuid 2.38.1 h0b41bf4_0
        - libuv 1.51.0 hb9d3cd8_0
        - libzlib 1.3.1 hb9d3cd8_2
        - llvm-openmp 20.1.8 h4922eb0_0
        - make 4.4.1 hb9d3cd8_2
        - ncurses 6.5 h2d0b736_3
        - ninja 1.13.1 h171cf75_0
        - openssl 3.5.1 h7b32b05_0
        - protobuf 6.31.1 py313hc6d18d0_0
        - python 3.13.5 hec9711d_102_cp313
        - python_abi 3.13 8_cp313
        - readline 8.2 h8c095d6_2
        - rhash 1.4.6 hb9d3cd8_1
        - sysroot_linux-64 2.17 h0157908_18
        - tk 8.6.13 noxft_hd72426e_102
        - tzdata 2025b h78e105d_0
        - zstd 1.5.7 hb8e6e7a_2
      host:
        - _openmp_mutex 4.5 3_kmp_llvm
        - attr 2.5.1 h166bdaf_1
        - brotli-python 1.1.0 py313h46c70d0_3
        - bzip2 1.0.8 h4bc722e_7
        - ca-certificates 2025.7.14 hbd8a1cb_0
        - certifi 2025.7.14 pyhd8ed1ab_0
        - cffi 1.17.1 py313hfab6e84_0
        - charset-normalizer 3.4.2 pyhd8ed1ab_0
        - cuda-cccl_linux-64 12.9.27 ha770c72_0
        - cuda-crt-dev_linux-64 12.9.86 ha770c72_1
        - cuda-cudart 12.9.79 h5888daf_0
        - cuda-cudart-dev 12.9.79 h5888daf_0
        - cuda-cudart-dev_linux-64 12.9.79 h3f2d84a_0
        - cuda-cudart-static 12.9.79 h5888daf_0
        - cuda-cudart-static_linux-64 12.9.79 h3f2d84a_0
        - cuda-cudart_linux-64 12.9.79 h3f2d84a_0
        - cuda-cupti 12.9.79 h9ab20c4_0
        - cuda-cupti-dev 12.9.79 h9ab20c4_0
        - cuda-driver-dev 12.9.79 h5888daf_0
        - cuda-driver-dev_linux-64 12.9.79 h3f2d84a_0
        - cuda-nvml-dev 12.9.79 hbd13f7d_0
        - cuda-nvrtc 12.9.86 h5888daf_0
        - cuda-nvrtc-dev 12.9.86 h5888daf_0
        - cuda-nvtx 12.9.79 h5888daf_0
        - cuda-nvtx-dev 12.9.79 ha770c72_0
        - cuda-profiler-api 12.9.79 h7938cbb_0
        - cuda-version 12.9 h4f385c5_3
        - cudnn 9.10.1.4 hbcb9cd8_1
        - cusparselt 0.7.1.0 h58dd1b1_2
        - eigen 3.4.0 h00ab1b0_0
        - h2 4.2.0 pyhd8ed1ab_0
        - hpack 4.1.0 pyhd8ed1ab_0
        - hyperframe 6.1.0 pyhd8ed1ab_0
        - icu 75.1 he02047a_0
        - idna 3.10 pyhd8ed1ab_1
        - ld_impl_linux-64 2.44 h1423503_1
        - libabseil 20250512.1 cxx17_hba17884_0
        - libblas 3.9.0 32_hfdb39a5_mkl
        - libcap 2.75 h39aace5_0
        - libcblas 3.9.0 32_h372d94f_mkl
        - libcublas 12.9.1.4 h9ab20c4_0
        - libcublas-dev 12.9.1.4 h9ab20c4_0
        - libcudnn 9.10.1.4 hf7e9902_1
        - libcudnn-dev 9.10.1.4 h58dd1b1_1
        - libcudss 0.6.0.5 h58dd1b1_0
        - libcudss-dev 0.6.0.5 hee47b17_0
        - libcufft 11.4.1.4 h5888daf_0
        - libcufft-dev 11.4.1.4 h5888daf_0
        - libcufile 1.14.1.1 ha8da6e3_0
        - libcufile-dev 1.14.1.1 h5888daf_0
        - libcurand 10.3.10.19 h9ab20c4_0
        - libcurand-dev 10.3.10.19 h9ab20c4_0
        - libcusolver 11.7.5.82 h9ab20c4_1
        - libcusolver-dev 11.7.5.82 h9ab20c4_1
        - libcusparse 12.5.10.65 h5888daf_1
        - libcusparse-dev 12.5.10.65 h5888daf_1
        - libexpat 2.7.1 hecca717_0
        - libffi 3.4.6 h2dba641_1
        - libgcc 15.1.0 h767d61c_3
        - libgcc-ng 15.1.0 h69a702a_3
        - libgcrypt-lib 1.11.1 hb9d3cd8_0
        - libgpg-error 1.55 h3f2d84a_0
        - libhwloc 2.11.2 default_h3d81e11_1002
        - libiconv 1.18 h4ce23a2_1
        - liblapack 3.9.0 32_hc41d3b0_mkl
        - liblzma 5.8.1 hb9d3cd8_2
        - libmagma 2.9.0 h9918c94_2
        - libmagma_sparse 2.9.0 h4951f4c_1
        - libmpdec 4.0.0 hb9d3cd8_0
        - libnl 3.11.0 hb9d3cd8_0
        - libnvjitlink 12.9.86 h5888daf_1
        - libprotobuf 6.31.1 h9ef548d_1
        - libsqlite 3.50.3 hee844dc_1
        - libstdcxx 15.1.0 h8f9b012_3
        - libstdcxx-ng 15.1.0 h4852527_3
        - libsystemd0 257.7 h4e0b6ca_0
        - {{ pin_subpackage('libtorch', exact=True) }}
        - libudev1 257.7 hbe16f8c_0
        - libuuid 2.38.1 h0b41bf4_0
        - libuv 1.51.0 hb9d3cd8_0
        - libxml2 2.13.8 h4bc477f_0
        - libzlib 1.3.1 hb9d3cd8_2
        - llvm-openmp 20.1.8 h4922eb0_0
        - lz4-c 1.10.0 h5888daf_1
        - magma 2.9.0 h622db9b_1
        - mkl 2024.2.2 ha957f24_16
        - mkl-devel 2024.2.2 ha770c72_16
        - mkl-include 2024.2.2 ha957f24_16
        - nccl 2.27.7.1 h49b9d9a_0
        - ncurses 6.5 h2d0b736_3
        - numpy 2.3.2 py313hf6604e3_0
        - nvtx-c 3.2.1 h3e4d06c_0
        - openssl 3.5.1 h7b32b05_0
        - pip 25.1.1 pyh145f28c_0
        - pkg-config 0.29.2 h4bc722e_1009
        - pybind11 3.0.0 pyh9380348_1
        - pybind11-global 3.0.0 pyhf748d72_1
        - pycparser 2.22 pyh29332c3_1
        - pysocks 1.7.1 pyha55dd90_7
        - python 3.13.5 hec9711d_102_cp313
        - python_abi 3.13 8_cp313
        - pyyaml 6.0.2 py313h8060acc_2
        - rdma-core 58.0 h5888daf_0
        - readline 8.2 h8c095d6_2
        - requests 2.32.4 pyhd8ed1ab_0
        - setuptools 80.9.0 pyhff2d567_0
        - six 1.17.0 pyhe01879c_1
        - sleef 3.8 h1b44611_0
        - tbb 2021.13.0 hceb3a55_1
        - tk 8.6.13 noxft_hd72426e_102
        - typing_extensions 4.14.1 pyhe01879c_0
        - tzdata 2025b h78e105d_0
        - urllib3 2.5.0 pyhd8ed1ab_0
        - yaml 0.2.5 h280c20c_3
        - zlib 1.3.1 hb9d3cd8_2
        - zstandard 0.23.0 py313h536fd9c_2
        - zstd 1.5.7 hb8e6e7a_2
      run:
        - {{ pin_subpackage('libtorch', exact=True) }}
      run_constrained:
        # These constraints ensure conflict between pytorch and
        # pytorch-cpu 1.1 which we built before conda-forge had GPU infrastructure
        # built into place.
        # https://github.com/conda-forge/pytorch-cpu-feedstock/issues/65
        - pytorch-cpu {{ version }}    # [cuda_compiler_version == "None"]
        - pytorch-gpu <0.0a0           # [cuda_compiler_version == "None"]
        - pytorch-gpu {{ version }}    # [cuda_compiler_version != "None"]
        - pytorch-cpu <0.0a0           # [cuda_compiler_version != "None"]

    test:
      requires:
        - _openmp_mutex                 4.5                           3_kmp_llvm
        - adwaita-icon-theme            48.1                          unix_0
        - at-spi2-atk                   2.38.0                        h0630a04_3
        - at-spi2-core                  2.40.3                        h0630a04_0
        - atk-1.0                       2.38.0                        h04ea711_2
        - attr                          2.5.1                         h166bdaf_1
        - attrs                         25.3.0                        pyh71513ae_0
        - binutils_impl_linux-64        2.44                          h4bf12b8_1
        - binutils_linux-64             2.44                          h4852527_1
        - boto3                         1.39.16                       pyhd8ed1ab_0
        - botocore                      1.39.16                       pyge310_1234567_0
        - brotli-python                 1.1.0                         py313h46c70d0_3
        - bzip2                         1.0.8                         h4bc722e_7
        - c-ares                        1.34.5                        hb9d3cd8_0
        - ca-certificates               2025.7.14                     hbd8a1cb_0
        - cairo                         1.18.4                        h3394656_0
        - cffi                          1.17.1                        py313hfab6e84_0
        - click                         8.2.1                         pyh707e725_0
        - cmake                         3.31.6                        h74e3db0_0
        - colorama                      0.4.6                         pyhd8ed1ab_1
        - cpython                       3.13.5                        py313hd8ed1ab_102
        - cuda-cccl_linux-64            12.9.27                       ha770c72_0
        - cuda-crt-dev_linux-64         12.9.86                       ha770c72_1
        - cuda-crt-tools                12.9.86                       ha770c72_1
        - cuda-cudart                   12.9.79                       h5888daf_0
        - cuda-cudart-dev               12.9.79                       h5888daf_0
        - cuda-cudart-dev_linux-64      12.9.79                       h3f2d84a_0
        - cuda-cudart-static            12.9.79                       h5888daf_0
        - cuda-cudart-static_linux-64   12.9.79                       h3f2d84a_0
        - cuda-cudart_linux-64          12.9.79                       h3f2d84a_0
        - cuda-cuobjdump                12.9.82                       hbd13f7d_0
        - cuda-cupti                    12.9.79                       h9ab20c4_0
        - cuda-driver-dev_linux-64      12.9.79                       h3f2d84a_0
        - cuda-nvcc-dev_linux-64        12.9.86                       he91c749_1
        - cuda-nvcc-impl                12.9.86                       h85509e4_1
        - cuda-nvcc-tools               12.9.86                       he02047a_1
        - cuda-nvcc_linux-64            12.9.86                       he0b4e1d_1
        - cuda-nvdisasm                 12.9.88                       hbd13f7d_0
        - cuda-nvrtc                    12.9.86                       h5888daf_0
        - cuda-nvrtc-dev                12.9.86                       h5888daf_0
        - cuda-nvtx                     12.9.79                       h5888daf_0
        - cuda-nvvm-dev_linux-64        12.9.86                       ha770c72_1
        - cuda-nvvm-impl                12.9.86                       he02047a_1
        - cuda-nvvm-tools               12.9.86                       he02047a_1
        - cuda-version                  12.9                          h4f385c5_3
        - cudnn                         9.10.1.4                      hbcb9cd8_1
        - dbus                          1.16.2                        h3c4dab8_0
        - epoxy                         1.5.10                        h166bdaf_1
        - exceptiongroup                1.3.0                         pyhd8ed1ab_0
        - execnet                       2.1.1                         pyhd8ed1ab_1
        - expecttest                    0.3.0                         pyhd8ed1ab_0
        - filelock                      3.18.0                        pyhd8ed1ab_0
        - font-ttf-dejavu-sans-mono     2.37                          hab24e00_0
        - font-ttf-inconsolata          3.000                         h77eed37_0
        - font-ttf-source-code-pro      2.038                         h77eed37_0
        - font-ttf-ubuntu               0.83                          h77eed37_3
        - fontconfig                    2.15.0                        h7e30c49_1
        - fonts-conda-ecosystem         1                             0
        - fonts-conda-forge             1                             0
        - freetype                      2.13.3                        ha770c72_1
        - fribidi                       1.0.10                        h36c2ea0_0
        - fsspec                        2025.7.0                      pyhd8ed1ab_0
        - gcc_impl_linux-64             14.3.0                        hd9e9e21_3
        - gcc_linux-64                  14.3.0                        h1382650_11
        - gdk-pixbuf                    2.42.12                       h7b179bb_1
        - glib-tools                    2.84.2                        h4833e2c_0
        - gmp                           6.3.0                         hac33072_2
        - gmpy2                         2.2.1                         py313h11186cd_0
        - graphite2                     1.3.14                        h5888daf_0
        - graphviz                      13.1.1                        h87b6fe6_0
        - gtk3                          3.24.43                       h0c6a113_5
        - gts                           0.7.6                         h977cf35_4
        - gxx_impl_linux-64             14.3.0                        he663afc_3
        - gxx_linux-64                  14.3.0                        ha7acb78_11
        - h2                            4.2.0                         pyhd8ed1ab_0
        - harfbuzz                      11.3.3                        hbb57e21_0
        - hicolor-icon-theme            0.17                          ha770c72_2
        - hpack                         4.1.0                         pyhd8ed1ab_0
        - hyperframe                    6.1.0                         pyhd8ed1ab_0
        - hypothesis                    6.136.6                       pyha770c72_0
        - icu                           75.1                          he02047a_0
        - iniconfig                     2.0.0                         pyhd8ed1ab_1
        - jinja2                        3.1.6                         pyhd8ed1ab_0
        - jmespath                      1.0.1                         pyhd8ed1ab_1
        - kernel-headers_linux-64       5.14.0                        he073ed8_2
        - keyutils                      1.6.1                         h166bdaf_0
        - krb5                          1.21.3                        h659f571_0
        - ld_impl_linux-64              2.44                          h1423503_1
        - lerc                          4.0.0                         h0aef613_1
        - libabseil                     20250512.1                    cxx17_hba17884_0
        - libblas                       3.9.0                         32_hfdb39a5_mkl
        - libcap                        2.75                          h39aace5_0
        - libcblas                      3.9.0                         32_h372d94f_mkl
        - libcublas                     12.9.1.4                      h9ab20c4_0
        - libcudnn                      9.10.1.4                      hf7e9902_1
        - libcudnn-dev                  9.10.1.4                      h58dd1b1_1
        - libcudss                      0.6.0.5                       h58dd1b1_0
        - libcufft                      11.4.1.4                      h5888daf_0
        - libcufile                     1.14.1.1                      ha8da6e3_0
        - libcups                       2.3.3                         hb8b1518_5
        - libcurand                     10.3.10.19                    h9ab20c4_0
        - libcurl                       8.14.1                        h332b0f4_0
        - libcusolver                   11.7.5.82                     h9ab20c4_1
        - libcusparse                   12.5.10.65                    h5888daf_1
        - libdeflate                    1.24                          h86f0d12_0
        - libedit                       3.1.20250104                  pl5321h7949ede_0
        - libev                         4.33                          hd590300_2
        - libexpat                      2.7.1                         hecca717_0
        - libffi                        3.4.6                         h2dba641_1
        - libfreetype                   2.13.3                        ha770c72_1
        - libfreetype6                  2.13.3                        h48d6fc4_1
        - libgcc                        15.1.0                        h767d61c_3
        - libgcc-devel_linux-64         14.3.0                        h85bb3a7_103
        - libgcc-ng                     15.1.0                        h69a702a_3
        - libgcrypt-lib                 1.11.1                        hb9d3cd8_0
        - libgd                         2.3.3                         h6f5c62b_11
        - libglib                       2.84.2                        h3618099_0
        - libgomp                       15.1.0                        h767d61c_3
        - libgpg-error                  1.55                          h3f2d84a_0
        - libhwloc                      2.11.2                        default_h3d81e11_1002
        - libiconv                      1.18                          h4ce23a2_1
        - libjpeg-turbo                 3.1.0                         hb9d3cd8_0
        - liblapack                     3.9.0                         32_hc41d3b0_mkl
        - liblzma                       5.8.1                         hb9d3cd8_2
        - libmagma                      2.9.0                         h9918c94_2
        - libmpdec                      4.0.0                         hb9d3cd8_0
        - libnghttp2                    1.64.0                        h161d5f1_0
        - libnl                         3.11.0                        hb9d3cd8_0
        - libnvjitlink                  12.9.86                       h5888daf_1
        - libpng                        1.6.50                        h421ea60_1
        - libprotobuf                   6.31.1                        h9ef548d_1
        - librsvg                       2.58.4                        he92a37e_3
        - libsanitizer                  14.3.0                        hd08acf3_3
        - libsqlite                     3.50.3                        hee844dc_1
        - libssh2                       1.11.1                        hcf80075_0
        - libstdcxx                     15.1.0                        h8f9b012_3
        - libstdcxx-devel_linux-64      14.3.0                        h85bb3a7_103
        - libstdcxx-ng                  15.1.0                        h4852527_3
        - libsystemd0                   257.7                         h4e0b6ca_0
        - libtiff                       4.7.0                         hf01ce69_5
        - libudev1                      257.7                         hbe16f8c_0
        - libuuid                       2.38.1                        h0b41bf4_0
        - libuv                         1.51.0                        hb9d3cd8_0
        - libwebp-base                  1.6.0                         hd42ef1d_0
        - libxcb                        1.17.0                        h8a09558_0
        - libxkbcommon                  1.10.0                        h65c71a3_0
        - libxml2                       2.13.8                        h4bc477f_0
        - libzlib                       1.3.1                         hb9d3cd8_2
        - llvm-openmp                   20.1.8                        h4922eb0_0
        - lz4-c                         1.10.0                        h5888daf_1
        - markupsafe                    3.0.2                         py313h8060acc_1
        - mkl                           2024.2.2                      ha770c72_16
        - mpc                           1.3.1                         h24ddda3_1
        - mpfr                          4.2.1                         h90cbb55_3
        - mpmath                        1.3.0                         pyhd8ed1ab_1
        - nccl                          2.27.7.1                      h49b9d9a_0
        - ncurses                       6.5                           h2d0b736_3
        - networkx                      3.5                           pyhe01879c_0
        - ninja                         1.13.1                        h171cf75_0
        - numpy                         2.3.2                         py313hf6604e3_0
        - nvtx-c                        3.2.1                         h3e4d06c_0
        - openssl                       3.5.1                         h7b32b05_0
        - optree                        0.17.0                        py313h7037e92_0
        - packaging                     25.0                          pyh29332c3_1
        - pango                         1.56.4                        hadf4263_0
        - pcre2                         10.45                         hc749103_0
        - pip                           25.1.1                        pyh145f28c_0
        - pixman                        0.46.4                        h537e5f6_0
        - pluggy                        1.6.0                         pyhd8ed1ab_0
        - pthread-stubs                 0.4                           hb9d3cd8_1002
        - pybind11                      3.0.0                         pyh9380348_1
        - pybind11-global               3.0.0                         pyhf748d72_1
        - pycparser                     2.22                          pyh29332c3_1
        - pydot                         4.0.1                         py313h78bf25f_0
        - pygments                      2.19.2                        pyhd8ed1ab_0
        - pyparsing                     3.2.3                         pyhe01879c_2
        - pysocks                       1.7.1                         pyha55dd90_7
        - pytest                        8.4.1                         pyhd8ed1ab_0
        - pytest-flakefinder            1.1.0                         pyh29332c3_2
        - pytest-rerunfailures          15.1                          pyhd8ed1ab_0
        - pytest-xdist                  3.8.0                         pyhd8ed1ab_0
        - python                        3.13.5                        hec9711d_102_cp313
        - python-dateutil               2.9.0.post0                   pyhe01879c_2
        - python_abi                    3.13                          8_cp313
        - rdma-core                     58.0                          h5888daf_0
        - readline                      8.2                           h8c095d6_2
        - rhash                         1.4.6                         hb9d3cd8_1
        - s3transfer                    0.13.1                        pyhd8ed1ab_0
        - setuptools                    80.9.0                        pyhff2d567_0
        - six                           1.17.0                        pyhe01879c_1
        - sleef                         3.8                           h1b44611_0
        - sortedcontainers              2.4.0                         pyhd8ed1ab_1
        - sympy                         1.14.0                        pyh2585a3b_105
        - sysroot_linux-64              2.34                          h087de78_2
        - tabulate                      0.9.0                         pyhd8ed1ab_2
        - tbb                           2021.13.0                     hceb3a55_1
        - tk                            8.6.13                        noxft_hd72426e_102
        - tomli                         2.2.1                         pyhe01879c_2
        - triton                        3.3.1                         cuda129py313h246eb7c_2
        - typing-extensions             4.14.1                        h4440ef1_0
        - typing_extensions             4.14.1                        pyhe01879c_0
        - tzdata                        2025b                         h78e105d_0
        - urllib3                       2.5.0                         pyhd8ed1ab_0
        - wayland                       1.24.0                        h3e06ad9_0
        - xkeyboard-config              2.45                          hb9d3cd8_0
        - xmlrunner                     1.7.7                         py_0
        - xorg-libice                   1.1.2                         hb9d3cd8_0
        - xorg-libsm                    1.2.6                         he73a12e_0
        - xorg-libx11                   1.8.12                        h4f16b4b_0
        - xorg-libxau                   1.0.12                        hb9d3cd8_0
        - xorg-libxcomposite            0.4.6                         hb9d3cd8_2
        - xorg-libxcursor               1.2.3                         hb9d3cd8_0
        - xorg-libxdamage               1.1.6                         hb9d3cd8_0
        - xorg-libxdmcp                 1.1.5                         hb9d3cd8_0
        - xorg-libxext                  1.3.6                         hb9d3cd8_0
        - xorg-libxfixes                6.0.1                         hb9d3cd8_0
        - xorg-libxi                    1.8.2                         hb9d3cd8_0
        - xorg-libxinerama              1.1.5                         h5888daf_1
        - xorg-libxrandr                1.5.4                         hb9d3cd8_0
        - xorg-libxrender               0.9.12                        hb9d3cd8_0
        - xorg-libxtst                  1.2.5                         hb9d3cd8_3
        - zstandard                     0.23.0                        py313h536fd9c_2
        - zstd                          1.5.7                         hb8e6e7a_2
      imports:
        - torch
        - torch._C
      files:
        - cmake_test/
      source_files:
        # Only include the source_files if we are actually going to run the tests.
        - test
        # tools/ is needed to optimise test run
        # as of pytorch=2.0.0, there is a bug when trying to run tests without the tools
        - tools
      commands:
        # Run pip check so as to ensure that all pytorch packages are installed
        # https://github.com/conda-forge/pytorch-cpu-feedstock/issues/24
        - pip check
        - python -c "import torch; print(torch.__version__)"
        - python -c "import torch; assert torch.backends.mkldnn.m.is_available()"  # [x86 and cuda_compiler_version == "None"]
        - python -c "import torch; torch.tensor(1).to('cpu').numpy(); print('numpy support enabled!!!')"
        # We have had issues with openmp .dylibs being doubly loaded in certain cases. These two tests catch the (observed) issue
        - python -c "import torch; import numpy"
        - python -c "import numpy; import torch"
        - python -c "import numpy as np;import torch;x = torch.tensor([2], dtype=torch.complex128);assert torch.dot(x, x).real == 4.0"
        # distributed support is enabled by default on linux; for mac, we enable it manually in build.sh
        - python -c "import torch; assert torch.distributed.is_available()"         # [linux or osx]
        - python -c "import torch; assert torch.backends.cuda.is_built()"           # [cuda_compiler_version != "None"]
        - python -c "import torch; assert torch.backends.cudnn.is_available()"      # [cuda_compiler_version != "None"]
        - python -c "import torch; assert torch.backends.cudnn.enabled"             # [cuda_compiler_version != "None"]
        - python -c "import torch; assert torch.version.cuda is not None"           # [cuda_compiler_version != "None"]
        # At conda-forge, we target versions of OSX that are too old for MPS support
        # But if users install a newer version of OSX, they will have MPS support
        # https://github.com/conda-forge/pytorch-cpu-feedstock/pull/123#issuecomment-1186355073
        # - python -c "import torch; assert torch.backends.mps.is_available()" # [osx]

        # python-version-specific library (default location in SP_DIR symlinks back to this)
        - test -f $PREFIX/lib/libtorch_python${SHLIB_EXT}           # [unix]
        - if not exist %LIBRARY_BIN%\torch_python.dll exit 1        # [win]
        - if not exist %SP_DIR%\torch\lib\torch_python.lib exit 1   # [win]
        - if not exist %SP_DIR%\torch\lib\_C.lib exit 1             # [win]

        # a reasonably safe subset of tests that should run under 15 minutes
        {% set tests = " ".join([
            "test/test_autograd.py",
            "test/test_autograd_fallback.py",
            "test/test_custom_ops.py",
            "test/test_linalg.py",
            "test/test_mkldnn.py",
            "test/test_modules.py",
            "test/test_nn.py",
            "test/test_torch.py",
            "test/test_xnnpack_integration.py",
        ]) %}
        # tests torch.compile; avoid on aarch because it adds >4h in test runtime in emulation;
        # they add a lot of runtime (15->60min on windows), so run them for only one python version
        {% set tests = tests ~ " test/inductor/test_torchinductor.py" %}    # [py==312 and not (aarch64 or osx)]

        {% set skips = "(TestTorch and test_print)" %}
        # minor tolerance violations
        {% set skips = skips ~ " or test_1_sized_with_0_strided_cpu_float32" %}         # [osx]
        {% set skips = skips ~ " or test_batchnorm_nhwc_cpu" %}                         # [unix]
        # timeouts and failures on aarch, see https://github.com/conda-forge/pytorch-cpu-feedstock/pull/298#issuecomment-2555888508
        {% set skips = skips ~ " or test_pynode_destruction_deadlock" %}                # [aarch64]
        {% set skips = skips ~ " or (TestLinalgCPU and test_cholesky_cpu_float32)" %}   # [aarch64]
        {% set skips = skips ~ " or (TestLinalgCPU and test_pca_lowrank_cpu)" %}        # [aarch64]
        {% set skips = skips ~ " or (TestLinalgCPU and test_svd_lowrank_cpu)" %}        # [aarch64]
        {% set skips = skips ~ " or (TestMkldnnCPU and test_lstm_cpu)" %}               # [aarch64]
        # very long-running tests in emulation
        {% set skips = skips ~ " or test_eigh_lwork_lapack" %}                          # [aarch64]
        {% set skips = skips ~ " or test_gradgrad_nn_LSTM" %}                           # [aarch64]
        {% set skips = skips ~ " or test_grad_nn_Transformer" %}                        # [aarch64]
        {% set skips = skips ~ " or test_inverse_errors_large" %}                       # [aarch64]
        {% set skips = skips ~ " or (TestXNNPACKConv1dTransformPass and test_conv1d_basic)" %}  # [aarch64]
        # errors (possibly QEMU-related) with openblas 0.3.30
        {% set skips = skips ~ " or test_addbmm or test_baddbmm or test_bmm" %}         # [aarch64]
        # doesn't crash, but gets different result on aarch + CUDA
        {% set skips = skips ~ " or illcondition_matrix_input_should_not_crash_cpu" %}  # [aarch64 and cuda_compiler_version != "None"]
        # may crash spuriously
        {% set skips = skips ~ " or (TestAutograd and test_profiler_seq_nr)" %}
        {% set skips = skips ~ " or (TestAutograd and test_profiler_propagation)" %}
        # tests that fail due to resource clean-up issues (non-unique temporary libraries), see
        # https://github.com/conda-forge/pytorch-cpu-feedstock/pull/318#issuecomment-2620080859
        {% set skips = skips ~ " or test_mutable_custom_op_fixed_layout" %}
        # trivial accuracy problems
        {% set skips = skips ~ " or test_BCELoss_weights_no_reduce_cuda" %}             # [unix and cuda_compiler_version != "None"]
        {% set skips = skips ~ " or test_ctc_loss_cudnn_tensor_cuda " %}                # [unix and cuda_compiler_version != "None"]
        {% set skips = skips ~ " or (TestTorch and test_index_add_correctness)" %}      # [unix and cuda_compiler_version != "None"]
        # These tests require higher-resource or more recent GPUs than the CI provides
        {% set skips = skips ~ " or test_sdpa_inference_mode_aot_compile" %}            # [linux and cuda_compiler_version != "None"]
        {% set skips = skips ~ " or (TestNN and test_grid_sample)" %}                   # [linux and cuda_compiler_version != "None"]
        # don't mess with tests that rely on GPU failure handling
        {% set skips = skips ~ " or test_cublas_config_nondeterministic_alert_cuda" %}  # [linux and cuda_compiler_version != "None"]
        {% set skips = skips ~ " or test_cross_entropy_loss_2d_out_of_bounds_class" %}  # [linux and cuda_compiler_version != "None"]
        {% set skips = skips ~ " or test_indirect_device_assert" %}                     # [linux and cuda_compiler_version != "None"]
        {% set skips = skips ~ " or test_reentrant_parent_error_on_cpu_cuda" %}         # [linux and cuda_compiler_version != "None"]
        # test that fails to find temporary resource
        {% set skips = skips ~ " or (GPUTests and test_scatter_reduce2)" %}             # [linux and cuda_compiler_version != "None"]
        # ROCM test whose skip doesn't trigger
        {% set skips = skips ~ " or test_ck_blas_library_cpu" %}                        # [linux and cuda_compiler_version != "None"]
        # problem with finding output of `torch.cuda.tunable.write_file()`
        {% set skips = skips ~ " or test_matmul_offline_tunableop_cuda_float16" %}      # [linux and cuda_compiler_version != "None"]
        # catastropic accuracy failure in convolution
        {% set skips = skips ~ " or test_Conv3d_1x1x1_no_bias_cuda" %}                  # [linux and cuda_compiler_version != "None"]
        # some triton errors that appeared in #391
        {% set skips = skips ~ " or test_isinf_cuda" %}                                 # [linux and cuda_compiler_version != "None"]
        {% set skips = skips ~ " or test_donated_buffer_inplace_gpt" %}                 # [linux and cuda_compiler_version != "None"]
        {% set skips = skips ~ " or test_linear_dynamic_maxautotune_cuda" %}            # [linux and cuda_compiler_version != "None"]
        # skip some very long-running groups of tests (~30 minutes total)
        {% set skips = skips ~ " or (test_gradgrad_nn_Transformer and _cuda_)" %}       # [linux and cuda_compiler_version != "None"]
        {% set skips = skips ~ " or test_avg_pool3d_backward2" %}                       # [linux and cuda_compiler_version != "None"]
        # MKL problems
        {% set skips = skips ~ " or (TestLinalgCPU and test_inverse_errors_large_cpu)" %}           # [linux and blas_impl == "mkl" and cuda_compiler_version != "None"]
        # non-MKL problems
        {% set skips = skips ~ " or test_gather_scatter_cpu or test_index_put2_cpu " %}             # [linux and blas_impl != "mkl" and cuda_compiler_version != "None"]
        # these tests are failing with low -n values
        {% set skips = skips ~ " or test_base_does_not_require_grad_mode_nothing" %}
        {% set skips = skips ~ " or test_base_does_not_require_grad_mode_warn" %}
        {% set skips = skips ~ " or test_composite_registered_to_cpu_mode_nothing" %}
        # these tests are failing on windows
        {% set skips = skips ~ " or (TestMkldnnCPU and test_batch_norm_2d_cpu)" %}       # [win]
        {% set skips = skips ~ " or (TestNN and test_Conv1d_dilated)" %}                 # [win]
        {% set skips = skips ~ " or (TestNN and test_Conv1d_pad_same_dilated)" %}        # [win]
        {% set skips = skips ~ " or (TestNN and test_Conv2d_pad_same_dilated)" %}        # [win]
        {% set skips = skips ~ " or (TestNN and test_Conv2d_padding)" %}                 # [win]
        {% set skips = skips ~ " or (TestNN and test_Conv2d_strided)" %}                 # [win]
        {% set skips = skips ~ " or (TestNN and test_Conv3d_dilated)" %}                 # [win]
        {% set skips = skips ~ " or (TestNN and test_Conv3d_dilated_strided)" %}         # [win]
        {% set skips = skips ~ " or (TestNN and test_Conv3d_pad_same_dilated)" %}        # [win]
        {% set skips = skips ~ " or (TestNN and test_Conv3d_stride)" %}                  # [win]
        {% set skips = skips ~ " or (TestNN and test_Conv3d_stride_padding)" %}          # [win]
        # flaky test, fragile to GC behavior
        {% set skips = skips ~ " or (TestTorch and test_tensor_cycle_via_slots)" %}

        # the whole test suite takes forever, but we should get a good enough coverage
        # for potential packaging problems by running a fixed subset
        - export OMP_NUM_THREADS=4  # [unix]
        # reduced paralellism to avoid OOM for CUDA builds
        {% set jobs = "-n 2" %}
        {% set jobs = "-n 1" %}     # [linux64 and cuda_compiler_version != "None"]
        # test only one python version on aarch because emulation is super-slow;
        # disable hypothesis because it randomly yields health check errors
        - pytest {{ jobs }} {{ tests }} -k "not ({{ skips }})" -m "not hypothesis" --durations=50 --disable-warnings    # [not aarch64 or py==312]

        # regression test for https://github.com/conda-forge/pytorch-cpu-feedstock/issues/329, where we picked up
        # duplicate `.pyc` files due to newest py-ver (3.13) in the build environment not matching the one in host;
        # obviously this test can only be done for other python versions.
        - test ! -f $SP_DIR/functorch/__pycache__/__init__.cpython-313.pyc          # [py!=313 and unix]
        - if exist %SP_DIR%\functorch\__pycache__\__init__.cpython-313.pyc exit 1   # [py!=313 and win]

        # test integrity of CMake metadata and ensure that THPLayoutType is visible as a symbol from libtorch_python
        - cd cmake_test
        - cmake -GNinja -DCMAKE_CXX_STANDARD=17 -DWITH_TORCH_PYTHON=ON $CMAKE_ARGS .   # [unix]
        - cmake -GNinja -DCMAKE_CXX_STANDARD=17 -DWITH_TORCH_PYTHON=ON %CMAKE_ARGS% .  # [win]
        - cmake --build .                   # [unix]
        - cmake --build . --config Release  # [win]

  # 2021/08/01, hmaarrfk
  # While this seems like a roundabout way of defining the package name
  # It helps the linter avoid errors on a package not having tests.
  {% set pytorch_cpu_gpu = "pytorch-cpu" %}   # [cuda_compiler_version == "None"]
  {% set pytorch_cpu_gpu = "pytorch-gpu" %}   # [cuda_compiler_version != "None"]
  - name: {{ pytorch_cpu_gpu }}
    build:
      string: cuda{{ cuda_compiler_version | replace('.', '') }}_{{ blas_impl }}_h{{ PKG_HASH }}_{{ build }}    # [megabuild and cuda_compiler_version != "None"]
      string: cpu_{{ blas_impl }}_h{{ PKG_HASH }}_{{ build }}                                                   # [megabuild and cuda_compiler_version == "None"]
      string: cpu_{{ blas_impl }}_py{{ CONDA_PY }}_h{{ PKG_HASH }}_{{ build }}                                  # [not megabuild]
      detect_binary_files_with_prefix: false
    requirements:
      run:
        - pytorch {{ version }} cuda*_{{ blas_impl }}*{{ build }}   # [megabuild and cuda_compiler_version != "None"]
        - pytorch {{ version }} cpu_{{ blas_impl }}*{{ build }}     # [megabuild and cuda_compiler_version == "None"]
        - {{ pin_subpackage("pytorch", exact=True) }}               # [not megabuild]
    test:
      imports:
        - torch

about:
  home: https://pytorch.org/
  dev_url: https://github.com/pytorch/pytorch
  license: BSD-3-Clause
  license_family: BSD
  license_file:
    - LICENSE
    - NOTICE
    - third_party/CMake/Copyright.txt
  summary: PyTorch is an optimized tensor library for deep learning using GPUs and CPUs.
  description: |
    PyTorch is a Python package that provides two high-level features:
      - Tensor computation (like NumPy) with strong GPU acceleration
      - Deep neural networks built on a tape-based autograd system
    You can reuse your favorite Python packages such as NumPy, SciPy, and Cython to extend PyTorch when needed.
  doc_url: https://pytorch.org/docs/

extra:
  recipe-maintainers:
    - baszalmstra
    - benjaminrwilson
    - beckermr
    - h-vetinari
    - hmaarrfk
    - jeongseok-meta
    - mgorny
    - sodre
    - Tobias-Fischer
  feedstock-name: pytorch-cpu
